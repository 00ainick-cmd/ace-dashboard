<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACE Command Center</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --text-dim: #808080;
      --accent: #00ff88;
      --hot: #ff4444;
      --warm: #ffaa00;
      --cold: #4488ff;
      --committed: #00ff88;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }
    
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 { font-size: 1.25rem; font-weight: 600; color: var(--accent); }
    
    nav { display: flex; gap: 0.5rem; }
    
    .tab {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    
    .tab:hover { border-color: var(--text-dim); }
    .tab.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 600; }
    
    main { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
    
    .view { display: none; }
    .view.active { display: block; }
    
    .gtd-section { margin-bottom: 2rem; }
    
    .gtd-section h2 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .gtd-section h2 .count {
      background: var(--border);
      color: var(--text);
      padding: 0.1rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
    }
    
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .card-title { font-weight: 600; font-size: 0.95rem; }
    .card-meta { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.25rem; }
    
    .badge {
      display: inline-block;
      font-size: 0.625rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.05em;
      margin-left: 0.5rem;
    }
    
    .badge.hot { background: var(--hot); color: white; }
    .badge.warm { background: var(--warm); color: black; }
    .badge.cold { background: var(--cold); color: white; }
    .badge.committed { background: var(--committed); color: black; }
    .badge.active { background: var(--accent); color: black; }
    .badge.waiting { background: var(--warm); color: black; }
    
    .project-card { border-left: 3px solid var(--accent); }
    .project-card.on_hold { border-left-color: var(--warm); }
    
    .project-tasks { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); }
    .project-tasks .task-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.875rem;
      color: var(--text-dim);
    }
    .project-tasks .task-item::before {
      content: "‚Üí";
      color: var(--accent);
    }
    
    .empty { color: var(--text-dim); font-style: italic; font-size: 0.875rem; padding: 0.5rem 0; }
    
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; text-align: center; }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }
    
    .filters { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .filter {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .filter.active { background: var(--border); color: var(--text); }
    
    .contact-list { margin-top: 0.5rem; }
    .contact { display: flex; justify-content: space-between; padding: 0.4rem 0.5rem; background: var(--bg); border-radius: 4px; margin-bottom: 0.25rem; font-size: 0.8rem; }
    .contact-name { font-weight: 500; }
    .contact-email { color: var(--accent); }
    
    .card.expandable { cursor: pointer; }
    .card-details { display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); }
    .card.expanded .card-details { display: block; }
    
    .notes { font-size: 0.8rem; color: var(--text-dim); white-space: pre-wrap; }
    
    .last-updated { text-align: center; color: var(--text-dim); font-size: 0.75rem; margin-top: 2rem; }

    @media (max-width: 600px) {
      .header-content { flex-direction: column; gap: 1rem; }
      nav { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>‚ö° ACE Command Center</h1>
      <nav>
        <button class="tab active" data-view="gtd">GTD</button>
        <button class="tab" data-view="crm">CRM</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- GTD View -->
    <div id="gtd" class="view active">
      <div class="stats" id="gtd-stats"></div>
      
      <div class="gtd-section" id="inbox-section">
        <h2>üì• Inbox <span class="count" id="inbox-count">0</span></h2>
        <div id="inbox-list"></div>
      </div>
      
      <div class="gtd-section" id="next-section">
        <h2>‚ö° Next Actions <span class="count" id="next-count">0</span></h2>
        <div id="next-list"></div>
      </div>
      
      <div class="gtd-section" id="waiting-section">
        <h2>‚è≥ Waiting For <span class="count" id="waiting-count">0</span></h2>
        <div id="waiting-list"></div>
      </div>
      
      <div class="gtd-section" id="projects-section">
        <h2>üìÅ Active Projects <span class="count" id="projects-count">0</span></h2>
        <div id="projects-list"></div>
      </div>
      
      <div class="gtd-section" id="someday-section">
        <h2>üí≠ Someday / Maybe <span class="count" id="someday-count">0</span></h2>
        <div id="someday-list"></div>
      </div>
      
      <div class="last-updated" id="last-updated"></div>
    </div>

    <!-- CRM View -->
    <div id="crm" class="view">
      <div class="stats" id="crm-stats"></div>
      <div class="filters" id="crm-filters">
        <button class="filter active" data-filter="all">All</button>
        <button class="filter" data-filter="committed">Committed</button>
        <button class="filter" data-filter="hot">Hot</button>
        <button class="filter" data-filter="warm">Warm</button>
        <button class="filter" data-filter="cold">Cold</button>
      </div>
      <div id="schools-list"></div>
    </div>
  </main>

  <script>
    const SUPABASE_URL = 'https://kyrdzjkjkzrwfepnnqzb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5cmR6amtqa3pyd2ZlcG5ucXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzU0NTgsImV4cCI6MjA4NTk1MTQ1OH0.C5KWamfX-Rkq9_NW4jKp_UjuFpEzZ-_GW-0u1C-iShQ';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let tasks = [];
    let projects = [];
    let schools = [];
    let currentCrmFilter = 'all';

    // Navigation
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.view).classList.add('active');
      });
    });

    // CRM Filters
    document.getElementById('crm-filters').addEventListener('click', (e) => {
      if (e.target.classList.contains('filter')) {
        document.querySelectorAll('#crm-filters .filter').forEach(f => f.classList.remove('active'));
        e.target.classList.add('active');
        currentCrmFilter = e.target.dataset.filter;
        renderSchools();
      }
    });

    // Load Data
    async function loadAll() {
      const [tasksRes, projectsRes, schoolsRes] = await Promise.all([
        db.from('tasks').select('*').order('created_at', { ascending: false }),
        db.from('projects').select('*').order('created_at', { ascending: false }),
        db.from('schools_crm').select('*').order('created_at', { ascending: false })
      ]);
      
      tasks = tasksRes.data || [];
      projects = projectsRes.data || [];
      schools = schoolsRes.data || [];
      
      renderGTD();
      renderSchools();
      renderCrmStats();
      
      document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
    }

    function renderGTD() {
      const inbox = tasks.filter(t => t.status === 'inbox');
      const next = tasks.filter(t => t.status === 'next_action');
      const waiting = tasks.filter(t => t.status === 'waiting');
      const someday = tasks.filter(t => t.status === 'someday');
      const activeProjects = projects.filter(p => p.status === 'active');
      
      // Stats
      document.getElementById('gtd-stats').innerHTML = `
        <div class="stat"><div class="stat-value">${inbox.length}</div><div class="stat-label">Inbox</div></div>
        <div class="stat"><div class="stat-value">${next.length}</div><div class="stat-label">Next Actions</div></div>
        <div class="stat"><div class="stat-value">${waiting.length}</div><div class="stat-label">Waiting</div></div>
        <div class="stat"><div class="stat-value">${activeProjects.length}</div><div class="stat-label">Projects</div></div>
      `;
      
      // Counts
      document.getElementById('inbox-count').textContent = inbox.length;
      document.getElementById('next-count').textContent = next.length;
      document.getElementById('waiting-count').textContent = waiting.length;
      document.getElementById('projects-count').textContent = activeProjects.length;
      document.getElementById('someday-count').textContent = someday.length;
      
      // Inbox
      document.getElementById('inbox-list').innerHTML = inbox.length 
        ? inbox.map(t => `<div class="card"><div class="card-title">${t.title}</div>${t.description ? `<div class="card-meta">${t.description}</div>` : ''}</div>`).join('')
        : '<div class="empty">Inbox empty ‚Äî all processed!</div>';
      
      // Next Actions
      document.getElementById('next-list').innerHTML = next.length
        ? next.map(t => `<div class="card"><div class="card-title">${t.title}</div>${t.description ? `<div class="card-meta">${t.description}</div>` : ''}</div>`).join('')
        : '<div class="empty">No next actions defined</div>';
      
      // Waiting
      document.getElementById('waiting-list').innerHTML = waiting.length
        ? waiting.map(t => `<div class="card"><div class="card-title">${t.title}</div>${t.description ? `<div class="card-meta">${t.description}</div>` : ''}</div>`).join('')
        : '<div class="empty">Nothing pending</div>';
      
      // Projects
      document.getElementById('projects-list').innerHTML = activeProjects.length
        ? activeProjects.map(p => {
            const projectTasks = tasks.filter(t => t.project_id === p.id && t.status === 'next_action');
            return `
              <div class="card project-card ${p.status}">
                <div class="card-title">${p.name}<span class="badge active">${p.status}</span></div>
                ${p.description ? `<div class="card-meta">${p.description}</div>` : ''}
                ${projectTasks.length ? `
                  <div class="project-tasks">
                    ${projectTasks.map(t => `<div class="task-item">${t.title}</div>`).join('')}
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')
        : '<div class="empty">No active projects</div>';
      
      // Someday
      document.getElementById('someday-list').innerHTML = someday.length
        ? someday.map(t => `<div class="card"><div class="card-title">${t.title}</div>${t.description ? `<div class="card-meta">${t.description}</div>` : ''}</div>`).join('')
        : '<div class="empty">Nothing in someday pile</div>';
    }

    function renderCrmStats() {
      const stats = {
        total: schools.length,
        committed: schools.filter(s => s.interest_level === 'committed').length,
        hot: schools.filter(s => s.interest_level === 'hot').length,
        warm: schools.filter(s => s.interest_level === 'warm').length,
      };
      document.getElementById('crm-stats').innerHTML = `
        <div class="stat"><div class="stat-value">${stats.total}</div><div class="stat-label">Total</div></div>
        <div class="stat"><div class="stat-value">${stats.committed}</div><div class="stat-label">Committed</div></div>
        <div class="stat"><div class="stat-value">${stats.hot}</div><div class="stat-label">Hot</div></div>
        <div class="stat"><div class="stat-value">${stats.warm}</div><div class="stat-label">Warm</div></div>
      `;
    }

    function renderSchools() {
      const filtered = currentCrmFilter === 'all' ? schools : schools.filter(s => s.interest_level === currentCrmFilter);
      if (!filtered.length) {
        document.getElementById('schools-list').innerHTML = '<div class="empty">No schools found</div>';
        return;
      }
      document.getElementById('schools-list').innerHTML = filtered.map(school => {
        const contacts = school.contact_info?.contacts || [];
        return `
          <div class="card expandable" onclick="this.classList.toggle('expanded')">
            <div class="card-title">
              ${school.school_name}
              <span class="badge ${school.interest_level}">${school.interest_level}</span>
            </div>
            <div class="card-meta">
              ${school.location_city ? school.location_city + ', ' : ''}${school.location_state || ''}
              ${school.school_type ? ' ¬∑ ' + school.school_type : ''}
            </div>
            <div class="card-details">
              ${contacts.length ? `
                <div class="contact-list">
                  ${contacts.map(c => `
                    <div class="contact">
                      <span class="contact-name">${c.name} ${c.role ? `(${c.role})` : ''}</span>
                      ${c.email ? `<span class="contact-email">${c.email}</span>` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              ${school.buying_process_notes ? `<div class="notes" style="margin-top:0.5rem">${school.buying_process_notes}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Auto-refresh every 30 seconds
    loadAll();
    setInterval(loadAll, 30000);
  </script>
</body>
</html>
